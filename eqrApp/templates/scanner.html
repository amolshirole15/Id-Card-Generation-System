{% load qr_code %}{% load static %}
<style>
    #uni_modal .modal-footer {
        display: none;
    }

    #uni_modal .modal-sub-footer {
        display: flex;
    }

    #scanner-holder {
        width: 100%;
        height: 100%;
        margin: 0px auto;
        position: relative;
    }

    #qr-reader {
        width: 100%;
        height: 100%;
    }

    #scanner-focus {
        background: #00000085;
        -webkit-clip-path: polygon(0% 0%, 0% 100%, 25% 100%, 25% 25%, 75% 25%, 75% 75%, 25% 75%, 25% 100%, 100% 100%, 100% 0%);
        clip-path: polygon(0% 0%, 0% 100%, 25% 100%, 25% 25%, 75% 25%, 75% 75%, 25% 75%, 25% 100%, 100% 100%, 100% 0%);
        height: 100%;
        width: 100%;
        top: 0;
        left: 0;
    }
</style>

<div class="container-fluid">
    <div id="scanner-holder" class="position-relative">
        <div id="qr-reader"></div>
        <div id="scanner-focus" class="position-absolute"></div>
    </div>
</div>
<script>
    // Function to start the camera
    async function startCamera() {
        let qrCodeScanner = null; 
        try {
            qrCodeScanner = new Html5Qrcode("qr-reader");
            if (!qrCodeScanner) {
            }

            // Start scanning
            await qrCodeScanner.start(
                { facingMode: "environment" }, // Use the rear camera
                {
                    fps: 10, // Frames per second
                    qrbox: { width: 350, height: 350 }, // Scanning area
                },
                (decodedText, decodedResult) => {
                    console.log("Scanned content:", decodedText);

                    // Handle the scanned result
                    $('#uni_modal').modal('hide');
                    start_loader();
                    setTimeout(() => {
                        uni_modal("View Employee Details", "{% url 'scanned-code' %}/" + decodedText, 'modal-md');
                        stopCamera(); // Stop camera after successful scan
                    }, 500);
                },
                (errorMessage) => {
                    console.warn("QR scan error:", errorMessage);
                }
            );
        } catch (error) {
            console.error("Error starting QR scanner:", error);
            alert("Unable to access the camera. Please check permissions and try again.");
        }
    }

    // Function to stop the camera
    function stopCamera() {
        if (qrCodeScanner) {
            qrCodeScanner.stop().then(() => {
                console.log("Camera stopped.");
                qrCodeScanner.clear();
                qrCodeScanner = null;
            }).catch(err => {
                console.error("Error stopping the camera:", err);
            });
        }
    }

    // Modal event listeners
    $('#uni_modal').on('shown.bs.modal', function () {
        if ($('#qr-reader').length > 0) {
            startCamera(); // Start camera when modal is shown
        }
    });

    $('#uni_modal').on('hide.bs.modal', function () {
        stopCamera(); // Stop camera when modal is hidden
    });
</script>